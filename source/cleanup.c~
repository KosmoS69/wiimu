#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <malloc.h>
#include <ogcsys.h>
#include <gccore.h>
#include <ogc/es.h>
#include <ogc/isfs.h>
#include <ogc/ipc.h>
#include <ogc/ios.h>
#include <ogc/dvd.h>	
#include <ogc/wiilaunch.h>
#include <wiiuse/wpad.h>
#include <fat.h>

#include "cleanup.h"
#include "rethandle.h"
#include "general.h"
#include "screen.h"

#include "pretty.h"
#include "sysconf.h"

void Finish(int retval)
{
	VIDEO_Flush();
	VIDEO_WaitVSync();
	printf("\n\nEnding ES!... ");
	WIILIGHT_SetLevel(255/4);
	int retval2=__ES_Close();
	WIILIGHT_SetLevel(255);
	if(retval2!=0)
	{
		printf("FAILED!\n\tQuitting...\n");
		goto _es_phailed;
	}
	printf("SUCCESS!\nEnding ISFS!... ");
	WIILIGHT_SetLevel(255/4);
_es_phailed:
	retval2=ISFS_Deinitialize();
	WIILIGHT_SetLevel(255);
	if(retval2!=0)
	{
		printf("FAILED!\n\tQuitting...\n");
		goto _isfs_phailed;
	}
	printf("SUCCESS!\n");
	
_isfs_phailed:
	exit(retval);
}

void initialize_wiimu()
{
	VIDEO_Init();
	WPAD_Init();
	AUDIO_Init(NULL);
	PAD_Init();
	
	GXRModeObj* rmode=currentRMode();
	rmode=VIDEO_GetPreferredMode(NULL);
	void* xfb=currentXFB();
	xfb = MEM_K0_TO_K1(SYS_AllocateFramebuffer(rmode));
	ClearScreen();
	if(rmode->viTVMode&VI_NON_INTERLACE)
		VIDEO_WaitVSync();

	if(__ES_Init()!=0)
	{
		printf("FAILED!\n\tQuitting... \n");
		RetvalFail(1);
	}
	if(ISFS_Initialize()!=0)
	{
		printf("FAILED!\n\tQuitting... \n");
		RetvalFail(1);
	}
	if(WII_Initialize()!=0)
	{
		printf("FAILED!\n\tQuitting... \n");
		RetvalFail(1);
	}
	fatInitDefault();
	
	Light_Start();
	language_setting=SYSCONF_GetLanguage();
	
}

